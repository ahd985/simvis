"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function getCookie(e){var t=null;if(document.cookie&&""!==document.cookie)for(var n=document.cookie.split(";"),i=0;i<n.length;i++){var r=jQuery.trim(n[i]);if(r.substring(0,e.length+1)===e+"="){t=decodeURIComponent(r.substring(e.length+1));break}}return t}function csrfSafeMethod(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)}function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return"s"+e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();d3.contextMenu=function(e,t){return d3.selectAll(".d3-context-menu").data([1]).enter().append("div").attr("class","d3-context-menu"),d3.select("body").on("click.d3-context-menu",function(){d3.select(".d3-context-menu").style("display","none")}),function(n,i){var r=this;d3.selectAll(".d3-context-menu").html("");var a=d3.selectAll(".d3-context-menu").append("ul");a.selectAll("li").data(e).enter().append("li").html(function(e){return e.title}).on("click",function(e,t){e.action(r,n,i),d3.select(".d3-context-menu").style("display","none")}),t&&t(n,i),d3.select(".d3-context-menu").style("left",d3.event.pageX-2+"px").style("top",d3.event.pageY-2+"px").style("display","block"),d3.event.preventDefault()}};var SimDraw=function(){function e(){_classCallCheck(this,e),this.elements={},this.active_element=null;var t=this;d3.select(".diagram-space").on("click",function(){t.deactivate_element()})}return _createClass(e,[{key:"add_element",value:function(e,t){return"rect"==e?this.elements[t]=new Rect(e,t):"circle"==e?this.elements[t]=new Circle(e,t):"path"==e&&(this.elements[t]=new Path(e,t)),this.elements[t]}},{key:"get_element",value:function(e){return this.elements[e]}},{key:"activate_element",value:function(e){null!=this.active_element&&this.elements[this.active_element].deactivate(),this.elements[e].activate(),this.active_element=e}},{key:"deactivate_element",value:function(){null!=this.active_element&&this.elements[this.active_element].deactivate(),this.active_element=null}},{key:"delete_element",value:function(e){}}]),e}(),Element=function(){function e(t,n,i,r){_classCallCheck(this,e),this.type=t,this.id=n,this.pos=i,this.dims=r,this.element_id="element",this.style={fill:"grey",stroke:"black",cursor:"move"},this.outline_id="outline",this.outline_style={fill:"none",stroke:"black","stroke-width":"1px","stroke-dasharray":"5,5"},this.outline_type="rect",this.outline_attr={visibility:"hidden"},this.resizer_id="resizer",this.resizer_style={fill:"red"},this.resizer_type="circle",this.resizer_attr={r:2,cursor:"se-resize",visibility:"hidden"},this.menu=[{title:"Move Forward",action:function(e,t,n){var i=e.parentNode.nextSibling;null!=i&&(null!=i.nextSibling?e.parentNode.parentNode.insertBefore(e.parentNode,i.nextSibling):e.parentNode.parentNode.appendChild(e.parentNode))}},{title:"Move Backwards",action:function(e,t,n){var i=e.parentNode.previousSibling;null!=i&&e.parentNode.parentNode.insertBefore(e.parentNode,i)}}]}return _createClass(e,[{key:"initialize",value:function(){var e=d3.select(".diagram").append("g").datum(this.pos).attr("transform","translate("+[this.pos.x,this.pos.y]+") scale(1,1)").attr("id",this.id);e.append(this.type).attr("id",this.element_id).styles(this.style).call(this.drag_move).on("click",function(){context.activate_element(this.parentNode.id)}).on("contextmenu",d3.contextMenu(this.menu)),e.append(this.outline_type).attr("id",this.outline_id).styles(this.outline_style).attrs(this.outline_attr),e.append(this.resizer_type).attrs(this.resizer_attr).attr("id",this.resizer_id).styles(this.resizer_style).call(this.drag_resize),this.render(this.dims)}},{key:"render",value:function(e){var t=d3.select("#"+this.id),n=t.datum();for(var i in e)n[i]=e[i];t.datum(n);var r=t.select("#"+this.outline_id),a=t.select("#"+this.element_id),s=t.select("#"+this.resizer_id);this.set_outline(r),this.set_element(a),this.set_resizer(s)}},{key:"move",value:function(e){var t=d3.select("#"+this.id),n=t.datum();n.x+=e.x,n.y+=e.y,t.datum(n).attr("transform",function(e,t){return"translate("+[e.x,e.y]+")"})}},{key:"activate",value:function(){var e=d3.select("#"+this.id);e.select("#"+this.outline_id).attr("visibility","visible"),e.selectAll("#"+this.resizer_id).each(function(){d3.select(this).attr("visibility","visible")})}},{key:"deactivate",value:function(){var e=d3.select("#"+this.id);e.select("#"+this.outline_id).attr("visibility","hidden"),e.selectAll("#"+this.resizer_id).each(function(){d3.select(this).attr("visibility","hidden")})}}]),e}(),Rect=function(e){function t(e,n){_classCallCheck(this,t);var i={x:0,y:0},r={width:50,height:50,margin:5},a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i,r));return a.drag_move=d3.drag().subject(function(){return{x:0,y:0}}).on("drag",function(){context.get_element(this.parentNode.id).move(d3.event)}),a.drag_resize=d3.drag().on("drag",function(e){context.get_element(this.parentNode.id).render({height:Math.max(1,d3.event.y-2*e.margin),width:Math.max(1,d3.event.x-2*e.margin)})}),a.initialize(),a}return _inherits(t,e),_createClass(t,[{key:"set_element",value:function(e){e.attr("x",function(e){return e.margin}).attr("y",function(e){return e.margin}).attr("height",function(e){return e.height}).attr("width",function(e){return e.width})}},{key:"set_outline",value:function(e){e.attr("height",function(e){return e.height+2*e.margin}).attr("width",function(e){return e.width+2*e.margin})}},{key:"set_resizer",value:function(e){e.attr("cx",function(e){return e.width+2*e.margin}).attr("cy",function(e){return e.height+2*e.margin})}}]),t}(Element),Circle=function(e){function t(e,n){_classCallCheck(this,t);var i={x:0,y:0},r={r:25,margin:5},a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i,r));return a.drag_move=d3.drag().subject(function(){return{x:0,y:0}}).on("drag",function(){context.get_element(this.parentNode.id).move(d3.event)}),a.drag_resize=d3.drag().on("drag",function(e){var t=d3.select("#"+this.parentNode.id).datum();context.get_element(this.parentNode.id).render({r:Math.max(Math.min(d3.event.x/2,d3.event.y/2)-t.margin,1),margin:t.margin})}),a.initialize(),a}return _inherits(t,e),_createClass(t,[{key:"set_element",value:function(e){e.attr("r",function(e){return e.r}).attr("cx",function(e){return e.r+e.margin}).attr("cy",function(e){return e.r+e.margin})}},{key:"set_resizer",value:function(e){e.attr("cx",function(e){return 2*(e.r+e.margin)}).attr("cy",function(e){return 2*(e.r+e.margin)})}},{key:"set_outline",value:function(e){e.attr("height",function(e){return 2*e.r+2*e.margin}).attr("width",function(e){return 2*e.r+2*e.margin})}}]),t}(Element),Path=function(e){function t(e,n){_classCallCheck(this,t);var i={x:0,y:0},r={path:[{x:0,y:0},{x:50,y:0}],"x-range":[0,50],"y-range":[0,0],margin:5},a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i,r));return a.drag_move=d3.drag().subject(function(){return{x:0,y:0}}).on("drag",function(){context.get_element(this.parentNode.id).move(d3.event)}),a.drag_resize=d3.drag().on("drag",function(e,t){var n=d3.select("#"+this.parentNode.id).datum().path;n[t].x=d3.event.x,n[t].y=d3.event.y,context.get_element(this.parentNode.id).render({path:n,"x-range":[d3.min(n,function(e){return e.x}),d3.max(n,function(e){return e.x})],"y-range":[d3.min(n,function(e){return e.y}),d3.max(n,function(e){return e.y})]})}),a.line_function=d3.line().x(function(e){return e.x}).y(function(e){return e.y}).curve(d3.curveLinear),a.initialize(),a}return _inherits(t,e),_createClass(t,[{key:"set_element",value:function(e){var t=d3.line().x(function(e){return e.x}).y(function(e){return e.y}).curve(d3.curveLinear);e.attr("d",function(e){return t(e.path)+"Z"})}},{key:"set_outline",value:function(e){e.attr("height",function(e){return e["y-range"][1]-e["y-range"][0]+2*e.margin}).attr("width",function(e){return e["x-range"][1]-e["x-range"][0]+2*e.margin}).attr("x",function(e){return e["x-range"][0]-e.margin}).attr("y",function(e){return e["y-range"][0]-e.margin})}},{key:"set_resizer",value:function(e){parent=d3.select(e.node().parentNode),parent.selectAll("#"+this.resizer_id).data(parent.datum().path).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).enter().append(this.resizer_type).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).attr("id",this.resizer_id).attrs(this.resizer_attr).styles(this.resizer_style).call(this.drag_resize)}}]),t}(Element);d3.selectAll(".shape-item").on("click",function(){var e=this.id;context.add_element(e,guid())});var csrftoken=getCookie("csrftoken");$.ajaxSetup({beforeSend:function(e,t){csrfSafeMethod(t.type)||this.crossDomain||e.setRequestHeader("X-CSRFToken",csrftoken)}}),context=null,$(document).ready(function(){context=new SimDraw,$("#data-upload-btn").on("click",function(){$("#data-upload-modal").modal("toggle")}),$(function(){$("#fileupload").fileupload({dataType:"json",done:function(e,t){$(".pre-upload").css("visibility","hidden"),$(".post-upload").css("visibility","visible");var n=$("#data-table").get()[0],i=new Handsontable(n,{data:t.result.data,rowHeaders:!0});i.updateSettings({contextMenu:{callback:function(e,t){"header_add"===e&&(row=i.getSelected()[0])},items:{header_add:{name:"Add to header",disabled:function(){return 0===i.getSelected()[0]}}}},cells:function(e,t,n){var i={};return e>0&&(i.readOnly=!0),i}})},progressall:function(e,t){var n=parseInt(t.loaded/t.total*100,10);$("#progress .bar").css("width",n+"%")}})})});