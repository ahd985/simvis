"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function getCookie(e){var t=null;if(document.cookie&&""!==document.cookie)for(var n=document.cookie.split(";"),i=0;i<n.length;i++){var r=jQuery.trim(n[i]);if(r.substring(0,e.length+1)===e+"="){t=decodeURIComponent(r.substring(e.length+1));break}}return t}function csrfSafeMethod(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)}function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return"s"+e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();d3.contextMenu=function(e,t){return d3.selectAll(".d3-context-menu").data([1]).enter().append("div").attr("class","d3-context-menu"),d3.select("body").on("click.d3-context-menu",function(){d3.select(".d3-context-menu").style("display","none")}),function(n,i){var r=this;d3.selectAll(".d3-context-menu").html("");var a=d3.selectAll(".d3-context-menu").append("ul");a.selectAll("li").data(e).enter().append("li").html(function(e){return e.title}).on("click",function(e,t){e.action(r,n,i),d3.select(".d3-context-menu").style("display","none")}),t&&t(n,i),d3.select(".d3-context-menu").style("left",d3.event.pageX-2+"px").style("top",d3.event.pageY-2+"px").style("display","block"),d3.event.preventDefault()}};var SimDraw=function(){function e(){_classCallCheck(this,e),this.elements={},this.active_element=null,this.headers=null,this.data_sample=null,this.data_manipulation=null;var t=this;d3.select(".diagram-space").on("click",function(){t.deactivate_element()}),this.func_map={add_element:this.add_element},new ElementMenu,new PropertiesMenu,this.element_context_menu=new ElementContextMenu;var t=this;d3.selectAll(".menu-item").on("click",function(){t.func_map[this.getAttribute("action")].call(t,this.id)})}return _createClass(e,[{key:"add_element",value:function(e){var t=guid();return"rect"==e?this.elements[t]=new Rect(e,t):"circle"==e?this.elements[t]=new Circle(e,t):"path"==e&&(this.elements[t]=new Path(e,t)),this.elements[t]}},{key:"get_element",value:function(e){return this.elements[e]}},{key:"activate_element",value:function(e){null!=this.active_element&&this.elements[this.active_element].deactivate(),this.gen_element_context_menu(this.elements[e].activate()),this.active_element=e,this.activate_element_context_menu(this.elements[e])}},{key:"activate_element_context_menu",value:function(e){this.element_context_menu.show()}},{key:"deactivate_element",value:function(){null!=this.active_element&&this.elements[this.active_element].deactivate(),this.active_element=null,this.deactivate_element_context_menu()}},{key:"deactivate_element_context_menu",value:function(){this.element_context_menu.hide()}},{key:"delete_element",value:function(e){}},{key:"set_headers",value:function(e){this.headers=e}},{key:"set_data_sample",value:function(e){this.data_sample=e}},{key:"set_data_manipulation",value:function(e){this.data_manipulation=e}},{key:"gen_element_context_menu",value:function(e){}}]),e}(),SideBarMenu=function(){function e(t){_classCallCheck(this,e),this.config=t,this.render()}return _createClass(e,[{key:"render",value:function(){var e=d3.select("#"+this.config.container).append("div").attr("id",this.config.id),t=this;this.config.menu_sections.map(function(n){var i=e.append("div").attr("class","menu-select-container");i.append("div").text(n.title),"sm-square"==n.layout?t.render_sm_square(i,n.contents):"form"==n.layout?t.render_form(i,n.contents):"buttons"==n.layout&&t.render_buttons(i,n.contents)})}},{key:"render_sm_square",value:function(e,t){var n=e.append("div").attr("class","menu-select");t.map(function(e){var t=n.append("a").attr("id",e.id).attr("action",e.action).attr("class","menu-item").append("svg").attr("class","menu-icon").append("g").attr("class","shape-svg-container").attr("transform","translate(0.5,0.5)").append(e.type).attr("class","shape-svg");for(var i in e)"type"!=i&&"id"!=i&&t.attr(i,e[i])})}},{key:"render_form",value:function(e,t){var n=e.attr("class","menu-select");t.map(function(e){if("select"==e.type){var t=n.append("div").append("select");e.options.map(function(e){t.append("option").attr("value",e.value).html(e.title)})}else if("radio"==e.type){var i=n.append("div").append("radio");e.inputs.map(function(e){i.append("input").attr("type","radio").attr("value",e.value),i.append("span").html(e.title)})}})}},{key:"render_buttons",value:function(e,t){var n=e.attr("class","menu-select");t.map(function(e){n.append("div").append("button").attr("class","menu-item").attr("action",e.action).html(e.title)})}}]),e}(),ElementMenu=function(e){function t(){_classCallCheck(this,t);var e={container:"left-sidebar-container",id:"element-menu",contextual:!1,menu_sections:[{title:"Elements",layout:"sm-square",contents:[{type:"rect",action:"add_element",id:"rect",x:2,y:10,height:16,width:31},{type:"circle",action:"add_element",id:"circle",r:8,cx:18,cy:18},{type:"path",action:"add_element",id:"path",d:"M2,18L31,18Z"}]}]};return _possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(SideBarMenu),ElementContextMenu=function(e){function t(e){_classCallCheck(this,t);var n={container:"right-sidebar-container",id:"element-context-menu",contextual:!0,menu_sections:[{title:"Conditions",layout:"buttons",contents:[{title:"Add Condition",action:"add_condition"}]}]},i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n));return i.hide(),i}return _inherits(t,e),_createClass(t,[{key:"show",value:function(e){d3.select("#element-context-menu").style("display","block")}},{key:"hide",value:function(){d3.select("#element-context-menu").style("display","none")}}]),t}(SideBarMenu),PropertiesMenu=function(e){function t(){_classCallCheck(this,t);var e={container:"right-sidebar-container",id:"properties-menu",contextual:"false",menu_sections:[{title:"Paper Size",layout:"form",contents:[{type:"select",options:[{title:"Regular",value:"portrait"},{title:"Wide",value:"landscape"}]},{type:"radio",inputs:[{title:"Portrait",value:"portrait"},{title:"Landscape",value:"landscape"}]}]}]};return _possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(SideBarMenu),ConditionMenu=function(e){function t(){_classCallCheck(this,t);var e={conditions:[]};return _possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(SideBarMenu),Element=function(){function e(t,n,i,r){_classCallCheck(this,e),this.type=t,this.id=n,this.pos=i,this.dims=r,this.element_id="element",this.style={fill:"grey",stroke:"black",cursor:"move"},this.outline_id="outline",this.outline_style={fill:"none",stroke:"black","stroke-width":"1px","stroke-dasharray":"5,5"},this.outline_type="rect",this.outline_attr={visibility:"hidden"},this.resizer_id="resizer",this.resizer_style={fill:"red"},this.resizer_type="circle",this.resizer_attr={r:2,cursor:"se-resize",visibility:"hidden"},this.context_menu,this.menu=[{title:"Move Forward",action:function(e,t,n){var i=e.parentNode.nextSibling;null!=i&&(null!=i.nextSibling?e.parentNode.parentNode.insertBefore(e.parentNode,i.nextSibling):e.parentNode.parentNode.appendChild(e.parentNode))}},{title:"Move Backwards",action:function(e,t,n){var i=e.parentNode.previousSibling;null!=i&&e.parentNode.parentNode.insertBefore(e.parentNode,i)}}]}return _createClass(e,[{key:"initialize",value:function(){var e=d3.select(".diagram").append("g").datum(this.pos).attr("transform","translate("+[this.pos.x,this.pos.y]+") scale(1,1)").attr("id",this.id);e.append(this.type).attr("id",this.element_id).styles(this.style).call(this.drag_move).on("click",function(){context.activate_element(this.parentNode.id)}).on("contextmenu",d3.contextMenu(this.menu)),e.append(this.outline_type).attr("id",this.outline_id).styles(this.outline_style).attrs(this.outline_attr),e.append(this.resizer_type).attrs(this.resizer_attr).attr("id",this.resizer_id).styles(this.resizer_style).call(this.drag_resize),this.render(this.dims)}},{key:"render",value:function(e){var t=d3.select("#"+this.id),n=t.datum();for(var i in e)n[i]=e[i];t.datum(n);var r=t.select("#"+this.outline_id),a=t.select("#"+this.element_id),s=t.select("#"+this.resizer_id);this.set_outline(r),this.set_element(a),this.set_resizer(s)}},{key:"move",value:function(e){var t=d3.select("#"+this.id),n=t.datum();n.x+=e.x,n.y+=e.y,t.datum(n).attr("transform",function(e,t){return"translate("+[e.x,e.y]+")"})}},{key:"activate",value:function(){var e=d3.select("#"+this.id);e.select("#"+this.outline_id).attr("visibility","visible"),e.selectAll("#"+this.resizer_id).each(function(){d3.select(this).attr("visibility","visible")})}},{key:"deactivate",value:function(){var e=d3.select("#"+this.id);e.select("#"+this.outline_id).attr("visibility","hidden"),e.selectAll("#"+this.resizer_id).each(function(){d3.select(this).attr("visibility","hidden")})}}]),e}(),Rect=function(e){function t(e,n){_classCallCheck(this,t);var i={x:0,y:0},r={width:50,height:50,margin:5},a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i,r));a.drag_move=d3.drag().subject(function(){return{x:0,y:0}}).on("drag",function(){context.get_element(this.parentNode.id).move(d3.event)}),a.drag_resize=d3.drag().on("drag",function(e){context.get_element(this.parentNode.id).render({height:Math.max(1,d3.event.y-2*e.margin),width:Math.max(1,d3.event.x-2*e.margin)})}),a.initialize();var s={conditions:[{color_levels:[372.7401979757573,408.50419817952684,444.2681983832963],color_scale:["#fdd49e","#fdbb84","#fc8d59"],data:[380],description:"Vapor Temp",id:"element_0",opacity:1,report:!1,type:"background",unit:"K"}],description:"Quench Tank",ids:["element"],type:"cell",x_series:[0]};ssv.create_demo_element("draw-svg",s).update(0,0);return a}return _inherits(t,e),_createClass(t,[{key:"set_element",value:function(e){e.attr("x",function(e){return e.margin}).attr("y",function(e){return e.margin}).attr("height",function(e){return e.height}).attr("width",function(e){return e.width})}},{key:"set_outline",value:function(e){e.attr("height",function(e){return e.height+2*e.margin}).attr("width",function(e){return e.width+2*e.margin})}},{key:"set_resizer",value:function(e){e.attr("cx",function(e){return e.width+2*e.margin}).attr("cy",function(e){return e.height+2*e.margin})}}]),t}(Element),Circle=function(e){function t(e,n){_classCallCheck(this,t);var i={x:0,y:0},r={r:25,margin:5},a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i,r));return a.drag_move=d3.drag().subject(function(){return{x:0,y:0}}).on("drag",function(){context.get_element(this.parentNode.id).move(d3.event)}),a.drag_resize=d3.drag().on("drag",function(e){var t=d3.select("#"+this.parentNode.id).datum();context.get_element(this.parentNode.id).render({r:Math.max(Math.min(d3.event.x/2,d3.event.y/2)-t.margin,1),margin:t.margin})}),a.initialize(),a}return _inherits(t,e),_createClass(t,[{key:"set_element",value:function(e){e.attr("r",function(e){return e.r}).attr("cx",function(e){return e.r+e.margin}).attr("cy",function(e){return e.r+e.margin})}},{key:"set_resizer",value:function(e){e.attr("cx",function(e){return 2*(e.r+e.margin)}).attr("cy",function(e){return 2*(e.r+e.margin)})}},{key:"set_outline",value:function(e){e.attr("height",function(e){return 2*e.r+2*e.margin}).attr("width",function(e){return 2*e.r+2*e.margin})}}]),t}(Element),Path=function(e){function t(e,n){_classCallCheck(this,t);var i={x:0,y:0},r={path:[{x:0,y:0},{x:50,y:0}],"x-range":[0,50],"y-range":[0,0],margin:5},a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i,r));return a.drag_move=d3.drag().subject(function(){return{x:0,y:0}}).on("drag",function(){context.get_element(this.parentNode.id).move(d3.event)}),a.drag_resize=d3.drag().on("drag",function(e,t){var n=d3.select("#"+this.parentNode.id).datum().path;n[t].x=d3.event.x,n[t].y=d3.event.y,context.get_element(this.parentNode.id).render({path:n,"x-range":[d3.min(n,function(e){return e.x}),d3.max(n,function(e){return e.x})],"y-range":[d3.min(n,function(e){return e.y}),d3.max(n,function(e){return e.y})]})}),a.line_function=d3.line().x(function(e){return e.x}).y(function(e){return e.y}).curve(d3.curveLinear),a.initialize(),a}return _inherits(t,e),_createClass(t,[{key:"set_element",value:function(e){var t=d3.line().x(function(e){return e.x}).y(function(e){return e.y}).curve(d3.curveLinear);e.attr("d",function(e){return t(e.path)+"Z"})}},{key:"set_outline",value:function(e){e.attr("height",function(e){return e["y-range"][1]-e["y-range"][0]+2*e.margin}).attr("width",function(e){return e["x-range"][1]-e["x-range"][0]+2*e.margin}).attr("x",function(e){return e["x-range"][0]-e.margin}).attr("y",function(e){return e["y-range"][0]-e.margin})}},{key:"set_resizer",value:function(e){parent=d3.select(e.node().parentNode),parent.selectAll("#"+this.resizer_id).data(parent.datum().path).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).enter().append(this.resizer_type).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).attr("id",this.resizer_id).attrs(this.resizer_attr).styles(this.resizer_style).call(this.drag_resize)}}]),t}(Element),csrftoken=getCookie("csrftoken");$.ajaxSetup({beforeSend:function(e,t){csrfSafeMethod(t.type)||this.crossDomain||e.setRequestHeader("X-CSRFToken",csrftoken)}}),context=null,$(document).ready(function(){context=new SimDraw,$("#data-upload-btn").on("click",function(){$("#data-upload-modal").modal("toggle")}),$(function(){$("#fileupload").fileupload({dataType:"json",done:function(e,t){$(".pre-upload").css("visibility","hidden"),$(".post-upload").css("visibility","visible");var n=$("#data-table").get()[0],i=new Handsontable(n,{data:t.result.data,rowHeaders:!0});i.updateSettings({contextMenu:{callback:function(e,t){if("header_add"===e){var n=i.getSelected()[0],r=i.getDataAtRow(0),a=i.getDataAtRow(n);r=r.map(function(e,t){return""!=a[t]?e+", "+a[t]:e}),i.alter("remove_row",n),r.map(function(e,t){i.setDataAtCell(0,t,e)})}},items:{header_add:{name:"Add to header",disabled:function(){return 0===i.getSelected()[0]}}}},cells:function(e,t,n){var i={};return e>0&&(i.readOnly=!0),i}}),$("#submit-data-btn").on("click",function(){var e=i.getData();context.set_headers(e[0]),context.set_data_sample(e.slice(1)),$("#data-upload-modal").modal("toggle")})},progressall:function(e,t){var n=parseInt(t.loaded/t.total*100,10);$("#progress .bar").css("width",n+"%")}})})});