"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function guid(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return"s"+t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();d3.contextMenu=function(t,e){return d3.selectAll(".d3-context-menu").data([1]).enter().append("div").attr("class","d3-context-menu"),d3.select("body").on("click.d3-context-menu",function(){d3.select(".d3-context-menu").style("display","none")}),function(n,i){var r=this;d3.selectAll(".d3-context-menu").html("");var a=d3.selectAll(".d3-context-menu").append("ul");a.selectAll("li").data(t).enter().append("li").html(function(t){return t.title}).on("click",function(t,e){t.action(r,n,i),d3.select(".d3-context-menu").style("display","none")}),e&&e(n,i),d3.select(".d3-context-menu").style("left",d3.event.pageX-2+"px").style("top",d3.event.pageY-2+"px").style("display","block"),d3.event.preventDefault()}};var SimDraw=function(){function t(){_classCallCheck(this,t),this.elements={},this.active_element=null}return _createClass(t,[{key:"add_element",value:function(t,e){return"rect"==t?this.elements[e]=new Rect(t,e):"circle"==t?this.elements[e]=new Circle(t,e):"path"==t&&(this.elements[e]=new Path(t,e)),this.elements[e]}},{key:"get_element",value:function(t){return this.elements[t]}},{key:"activate_element",value:function(t){null!=this.active_element&&this.elements[this.active_element].deactivate(),this.elements[t].activate(),this.active_element=t}},{key:"deactivate_element",value:function(){null!=this.active_element&&this.elements[this.active_element].deactivate(),this.active_element=null}},{key:"delete_element",value:function(t){}}]),t}(),Element=function(){function t(e,n,i,r){_classCallCheck(this,t),this.type=e,this.id=n,this.pos=i,this.dims=r,this.element_id="element",this.style={fill:"grey",stroke:"black",cursor:"move"},this.outline_id="outline",this.outline_style={fill:"none",stroke:"black","stroke-width":"1px","stroke-dasharray":"5,5"},this.outline_type="rect",this.outline_attr={visibility:"hidden"},this.resizer_id="resizer",this.resizer_style={fill:"red"},this.resizer_type="circle",this.resizer_attr={r:2,cursor:"se-resize",visibility:"hidden"},this.menu=[{title:"Move Forward",action:function(t,e,n){var i=t.parentNode.nextSibling;null!=i&&(null!=i.nextSibling?t.parentNode.parentNode.insertBefore(t.parentNode,i.nextSibling):t.parentNode.parentNode.appendChild(t.parentNode))}},{title:"Move Backwards",action:function(t,e,n){var i=t.parentNode.previousSibling;null!=i&&t.parentNode.parentNode.insertBefore(t.parentNode,i)}}]}return _createClass(t,[{key:"initialize",value:function(){var t=d3.select(".diagram").append("g").datum(this.pos).attr("transform","translate("+[this.pos.x,this.pos.y]+") scale(1,1)").attr("id",this.id);t.append(this.type).attr("id",this.element_id).styles(this.style).call(this.drag_move).on("click",function(){context.activate_element(this.parentNode.id)}).on("contextmenu",d3.contextMenu(this.menu)),t.append(this.outline_type).attr("id",this.outline_id).styles(this.outline_style).attrs(this.outline_attr),t.append(this.resizer_type).attrs(this.resizer_attr).attr("id",this.resizer_id).styles(this.resizer_style).call(this.drag_resize),this.render(this.dims)}},{key:"render",value:function(t){var e=d3.select("#"+this.id),n=e.datum();for(var i in t)n[i]=t[i];e.datum(n);var r=e.select("#"+this.outline_id),a=e.select("#"+this.element_id),s=e.select("#"+this.resizer_id);this.set_outline(r),this.set_element(a),this.set_resizer(s)}},{key:"move",value:function(t){var e=d3.select("#"+this.id),n=e.datum();n.x+=t.x,n.y+=t.y,e.datum(n).attr("transform",function(t,e){return"translate("+[t.x,t.y]+")"})}},{key:"activate",value:function(){var t=d3.select("#"+this.id);t.select("#"+this.outline_id).attr("visibility","visible"),t.selectAll("#"+this.resizer_id).each(function(){d3.select(this).attr("visibility","visible")})}},{key:"deactivate",value:function(){var t=d3.select("#"+this.id);t.select("#"+this.outline_id).attr("visibility","hidden"),t.selectAll("#"+this.resizer_id).each(function(){d3.select(this).attr("visibility","hidden")})}}]),t}(),Rect=function(t){function e(t,n){_classCallCheck(this,e);var i={x:0,y:0},r={width:50,height:50,margin:5},a=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,r));return a.drag_move=d3.drag().subject(function(){return{x:0,y:0}}).on("drag",function(){context.get_element(this.parentNode.id).move(d3.event)}),a.drag_resize=d3.drag().on("drag",function(t){context.get_element(this.parentNode.id).render({height:Math.max(1,d3.event.y-2*t.margin),width:Math.max(1,d3.event.x-2*t.margin)})}),a.initialize(),a}return _inherits(e,t),_createClass(e,[{key:"set_element",value:function(t){t.attr("x",function(t){return t.margin}).attr("y",function(t){return t.margin}).attr("height",function(t){return t.height}).attr("width",function(t){return t.width})}},{key:"set_outline",value:function(t){t.attr("height",function(t){return t.height+2*t.margin}).attr("width",function(t){return t.width+2*t.margin})}},{key:"set_resizer",value:function(t){t.attr("cx",function(t){return t.width+2*t.margin}).attr("cy",function(t){return t.height+2*t.margin})}}]),e}(Element),Circle=function(t){function e(t,n){_classCallCheck(this,e);var i={x:0,y:0},r={r:25,margin:5},a=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,r));return a.drag_move=d3.drag().subject(function(){return{x:0,y:0}}).on("drag",function(){context.get_element(this.parentNode.id).move(d3.event)}),a.drag_resize=d3.drag().on("drag",function(t){var e=d3.select("#"+this.parentNode.id).datum();context.get_element(this.parentNode.id).render({r:Math.max(Math.min(d3.event.x/2,d3.event.y/2)-e.margin,1),margin:e.margin})}),a.initialize(),a}return _inherits(e,t),_createClass(e,[{key:"set_element",value:function(t){t.attr("r",function(t){return t.r}).attr("cx",function(t){return t.r+t.margin}).attr("cy",function(t){return t.r+t.margin})}},{key:"set_resizer",value:function(t){t.attr("cx",function(t){return 2*(t.r+t.margin)}).attr("cy",function(t){return 2*(t.r+t.margin)})}},{key:"set_outline",value:function(t){t.attr("height",function(t){return 2*t.r+2*t.margin}).attr("width",function(t){return 2*t.r+2*t.margin})}}]),e}(Element),Path=function(t){function e(t,n){_classCallCheck(this,e);var i={x:0,y:0},r={path:[{x:0,y:0},{x:50,y:0}],"x-range":[0,50],"y-range":[0,0],margin:5},a=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,r));return a.drag_move=d3.drag().subject(function(){return{x:0,y:0}}).on("drag",function(){context.get_element(this.parentNode.id).move(d3.event)}),a.drag_resize=d3.drag().on("drag",function(t,e){var n=d3.select("#"+this.parentNode.id).datum().path;n[e].x=d3.event.x,n[e].y=d3.event.y,context.get_element(this.parentNode.id).render({path:n,"x-range":[d3.min(n,function(t){return t.x}),d3.max(n,function(t){return t.x})],"y-range":[d3.min(n,function(t){return t.y}),d3.max(n,function(t){return t.y})]})}),a.line_function=d3.line().x(function(t){return t.x}).y(function(t){return t.y}).curve(d3.curveLinear),a.initialize(),a}return _inherits(e,t),_createClass(e,[{key:"set_element",value:function(t){var e=d3.line().x(function(t){return t.x}).y(function(t){return t.y}).curve(d3.curveLinear);t.attr("d",function(t){return e(t.path)+"Z"})}},{key:"set_outline",value:function(t){t.attr("height",function(t){return t["y-range"][1]-t["y-range"][0]+2*t.margin}).attr("width",function(t){return t["x-range"][1]-t["x-range"][0]+2*t.margin}).attr("x",function(t){return t["x-range"][0]-t.margin}).attr("y",function(t){return t["y-range"][0]-t.margin})}},{key:"set_resizer",value:function(t){parent=d3.select(t.node().parentNode),parent.selectAll("#"+this.resizer_id).data(parent.datum().path).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).enter().append(this.resizer_type).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("id",this.resizer_id).attrs(this.resizer_attr).styles(this.resizer_style).call(this.drag_resize)}}]),e}(Element);d3.selectAll(".shape-item").on("click",function(){var t=this.id;context.add_element(t,guid())}),context=null,$(document).ready(function(){context=new SimDraw,console.log(d3.select(".diagram-background")),d3.select(".diagram-space").on("click",function(){console.log("click"),context.deactivate_element()})});